<UserControl x:Class="CableWrapMonitor.Dockable.CableWrapDockable"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:CableWrapMonitor.Dockable"
             xmlns:model="clr-namespace:CableWrapMonitor"
             xmlns:oxy="http://oxyplot.org/wpf"
             mc:Ignorable="d"
             d:DesignWidth="300" d:DesignHeight="700">

    <UserControl.Resources>

        <!--
            Status dot colour: green when tracking,
            red when the warning threshold has been exceeded, grey when disconnected.
        -->
        <Style x:Key="StatusDotStyle" TargetType="Ellipse">
            <Setter Property="Width"  Value="10" />
            <Setter Property="Height" Value="10" />
            <Setter Property="Margin" Value="0,0,6,0" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Style.Triggers>
                <DataTrigger Binding="{Binding Service.TrackingStatus}"
                             Value="{x:Static model:TrackingStatus.Stopped}">
                    <Setter Property="Fill" Value="#4A90D9" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Service.TrackingStatus}"
                             Value="{x:Static model:TrackingStatus.Tracking}">
                    <Setter Property="Fill" Value="#3CB371" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Service.TrackingStatus}"
                             Value="{x:Static model:TrackingStatus.Warning}">
                    <Setter Property="Fill" Value="#FF4444" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Service.TrackingStatus}"
                             Value="{x:Static model:TrackingStatus.NotConnected}">
                    <Setter Property="Fill" Value="Gray" />
                </DataTrigger>
            </Style.Triggers>
        </Style>

    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="8">

            <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Border BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="0,0,0,6"
                    Margin="0,0,0,8">
                <TextBlock Text="ðŸ”Œ Seestar Cable Wrap Monitor"
                           FontWeight="Bold"
                           FontSize="13"
                           Foreground="{DynamicResource PrimaryBrush}" />
            </Border>

            <!-- â”€â”€ Status row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Grid Margin="0,0,0,4">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Status:" VerticalAlignment="Center"
                           Foreground="{DynamicResource PrimaryBrush}" Margin="0,0,8,0"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Ellipse Style="{StaticResource StatusDotStyle}" />
                    <TextBlock VerticalAlignment="Center"
                               Foreground="{DynamicResource PrimaryBrush}">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Service.TrackingStatus}"
                                                 Value="{x:Static model:TrackingStatus.Stopped}">
                                        <Setter Property="Text" Value="Not Tracking" />
                                        <Setter Property="Foreground" Value="#4A90D9" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Service.TrackingStatus}"
                                                 Value="{x:Static model:TrackingStatus.Tracking}">
                                        <Setter Property="Text" Value="Tracking" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Service.TrackingStatus}"
                                                 Value="{x:Static model:TrackingStatus.Warning}">
                                        <Setter Property="Text" Value="âš  WRAP WARNING" />
                                        <Setter Property="FontWeight" Value="Bold" />
                                        <Setter Property="Foreground" Value="#FF4444" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Service.TrackingStatus}"
                                                 Value="{x:Static model:TrackingStatus.NotConnected}">
                                        <Setter Property="Text" Value="Not Connected" />
                                        <Setter Property="Foreground" Value="Gray" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Grid>

            <!-- â”€â”€ Total rotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Grid Margin="0,2,0,2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Total Rotation:"
                           Foreground="{DynamicResource PrimaryBrush}" Margin="0,0,8,0"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="{Binding Service.TotalDegreesRotated, StringFormat={}{0:+0.0;-0.0;0.0}Â°}"
                               FontWeight="Bold"
                               Foreground="{DynamicResource PrimaryBrush}" />
                    <!-- Movement direction indicator â€” pulses while scope is moving -->
                    <TextBlock Text="{Binding Service.MovementIndicator}"
                               FontWeight="Bold"
                               Margin="6,0,0,0"
                               Foreground="{DynamicResource PrimaryBrush}">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Service.IsMoving}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     From="1.0" To="0.2"
                                                                     Duration="0:0:0.8"
                                                                     AutoReverse="True" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     To="1.0" Duration="0:0:0.2" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Grid>

            <!-- â”€â”€ Wrap count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Grid Margin="0,2,0,2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Wrap Count:"
                           Foreground="{DynamicResource PrimaryBrush}" Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1"
                           Text="{Binding Service.WrapCount, StringFormat={}{0:+0.00;-0.00;0.00} wraps}"
                           FontWeight="Bold"
                           Foreground="{DynamicResource PrimaryBrush}" />
            </Grid>

            <!-- â”€â”€ Warning threshold â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Grid Margin="0,2,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Warning At:"
                           Foreground="{DynamicResource PrimaryBrush}" Margin="0,0,8,0"
                           VerticalAlignment="Center"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBox Width="50"
                             Text="{Binding Service.WarningThresholdRotations, StringFormat={}{0:0.0}, UpdateSourceTrigger=LostFocus}"
                             VerticalAlignment="Center"
                             Margin="0,0,4,0"
                             ToolTip="Warning threshold in rotations (0.5 â€“ 3.0). Press Enter or click away to apply." />
                    <TextBlock Text="rotations" VerticalAlignment="Center"
                               Foreground="{DynamicResource PrimaryBrush}" />
                    <TextBlock Text="{Binding Service.WarningThresholdDegrees, StringFormat= ({0:0}Â°)}"
                               VerticalAlignment="Center"
                               Foreground="Gray" />
                </StackPanel>
            </Grid>

            <!-- â”€â”€ Time-series chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <TextBlock Text="Rotation Tonight:"
                       FontWeight="Bold"
                       Foreground="{DynamicResource PrimaryBrush}"
                       Margin="0,4,0,2" />
            <oxy:PlotView Model="{Binding TimeSeriesModel}"
                          Height="130"
                          Background="Transparent"
                          Margin="0,0,0,4" />

            <!-- â”€â”€ Spiral chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <TextBlock Text="Cable Position:"
                       FontWeight="Bold"
                       Foreground="{DynamicResource PrimaryBrush}"
                       Margin="0,4,0,2" />
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="230" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <oxy:PlotView Grid.Column="1"
                              Width="230" Height="230"
                              Model="{Binding SpiralModel}"
                              Background="Transparent" />
            </Grid>

            <!-- â”€â”€ Separator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Border BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,1,0,0"
                    Margin="0,8,0,8" />

            <!-- â”€â”€ Wrap history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <TextBlock Text="Wrap History:"
                       FontWeight="Bold"
                       Foreground="{DynamicResource PrimaryBrush}"
                       Margin="0,0,0,4" />

            <Border BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="3"
                    Padding="4"
                    MaxHeight="200">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Service.WrapHistory}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,1,0,1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Timestamp, StringFormat=[{0:yyyy-MM-dd HH:mm}]}"
                                               Foreground="Gray"
                                               FontFamily="Consolas"
                                               FontSize="11"
                                               Margin="0,0,6,0" />
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding Note}"
                                               Foreground="{DynamicResource PrimaryBrush}"
                                               FontSize="11"
                                               TextWrapping="Wrap" />
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>

            <!-- Empty-history placeholder: visible only when list is empty -->
            <TextBlock Text="No crossings recorded yet."
                       Foreground="Gray"
                       FontStyle="Italic"
                       FontSize="11"
                       Margin="4,2,0,0">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Service.WrapHistory.Count}" Value="0">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <!-- â”€â”€ Separator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Border BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,1,0,0"
                    Margin="0,8,0,8" />

            <!-- â”€â”€ Unwind button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Button Command="{Binding UnwindCommand}"
                    HorizontalAlignment="Stretch"
                    Padding="8,6"
                    FontWeight="Bold"
                    Margin="0,0,0,4"
                    ToolTip="Automatically slews the mount in reverse to unwind the USB cable, then resets the counter.">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Content" Value="Unwind Cable Automatically" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Service.IsUnwinding}" Value="True">
                                <Setter Property="Content"    Value="Unwindingâ€¦ (do not interrupt)" />
                                <Setter Property="IsEnabled"  Value="False" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- â”€â”€ Reset button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Button Command="{Binding ResetCommand}"
                    Content="Reset â€” Cable Unwound"
                    HorizontalAlignment="Stretch"
                    Padding="8,6"
                    FontWeight="Bold"
                    ToolTip="Click only after you have physically unwound the USB cable.">
                <Button.Style>
                    <Style TargetType="Button">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Service.IsUnwinding}" Value="True">
                                <Setter Property="IsEnabled" Value="False" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- Reminder text below buttons -->
            <TextBlock Text="'Unwind' slews the mount to unwind the cable. 'Reset' confirms manual unwind."
                       Foreground="Gray"
                       FontSize="10"
                       FontStyle="Italic"
                       TextWrapping="Wrap"
                       HorizontalAlignment="Center"
                       Margin="0,4,0,0" />

        </StackPanel>
    </ScrollViewer>
</UserControl>
